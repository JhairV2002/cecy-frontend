<p-dialog
  header="Curso - Planificación"
  [(visible)]="dialogForm"
  [maximizable]="true"
  [modal]="true"
>
  <app-course-visualization-form
    [data]="selectedCourseVisualization"
    *ngIf="dialogForm"
    (dialogForm)="dialogForm = $event"
  ></app-course-visualization-form>
</p-dialog>

<p-dialog
  header="Acta de aprobación"
  [(visible)]="displayModalFiles"
  [modal]="true"
>
  <app-view-files
    [acceptAttributes]="'.pdf, .doc'"
    [loadingUpload]="loadingUploadFiles"
    [filesIn]="files"
    [loadingFiles]="loadingFiles"
    [paginatorIn]="paginatorFiles"
    (files)="uploadFiles($event)"
    (paginatorOut)="loadFiles()"
    (searchOut)="filterFiles.setValue($event); loadFiles()"
  >
  </app-view-files>
</p-dialog>

<app-course-kpi [data$]="courseVisualizations$"></app-course-kpi>
<p-toolbar>
  <div class="p-toolbar-group-left">
    <button
      pButton
      pRipple
      type="button"
      label="Refrescar"
      class="p-button-rounded ml-2"
      icon="pi pi-sync"
      (click)="loadCourseVisualizations(paginator.current_page)"
    ></button>
  </div>
</p-toolbar>
<p-card>
  <p-paginator
    [rows]="paginator.per_page!"
    [totalRecords]="paginator.total!"
    (onPageChange)="paginate($event)"
  >
  </p-paginator>
  <p-table
    dataKey="id"
    styleClass="p-datatable-striped"
    [value]="(courseVisualizations$ | async)?.data"
    [columns]="cols"
    [loading]="(loaded$ | async)!"
    [(selection)]="selectedCourseVisualizations"
    [responsive]="true"
  >
    <ng-template pTemplate="header" let-columns>
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th *ngFor="let col of columns" [pSortableColumn]="col.field">
          {{ col.header }}
          <p-sortIcon [field]="col.field"></p-sortIcon>
        </th>
        <th class="text-center">
          <button
            pButton
            pRipple
            type="button"
            class="p-button-rounded p-button-secondary"
            icon="pi pi-cog"
          ></button>
        </th>
      </tr>
    </ng-template>
    <ng-template
      pTemplate="body"
      let-rowData
      let-columns="columns"
      let-rowIndex="rowIndex"
    >
      <tr [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex">
        <td>
          <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
        </td>
        <!-- <td>
            {{rowData['code']}}
          </td> -->
        <!-- <td>
            {{rowData['name']}}
          </td> -->
        <td>
          {{ rowData["state"].name }}

          <!-- <div class="field xl:col-6 lg:col-6 md:col-12 sm:col-12"> -->
          <label for="state" appLabel label="Tipo de estados del curso:">
          </label>
          <p-dropdown
            #estado
            (onChange)="Save(rowData, $event.value)"
            id="state"
            dataKey="id"
            [options]="courseStates"
            [filter]="true"
            filterBy="name"
            placeholder="Seleccione"
          >
            <ng-template pTemplate="selectedItem">
              <div>
                <div>{{ estado.value?.name }}</div>
              </div>
            </ng-template>
            <ng-template let-item pTemplate="item">
              <div>
                <div>{{ item.name }}</div>
              </div>
            </ng-template>
          </p-dropdown>
        </td>
        <!-- <td>
            {{rowData['career'].name}}
          </td> -->

        <!-- <td>
            {{rowData['teacherResponsibleForTheCourse'].name}}
          </td>
          <td>
            {{rowData['startedTime'].name}}
          </td>
          <td>
            {{rowData['endedTime'].name}}
          </td>
          <td>
            {{rowData['responsibleTeacher'].name}}
          </td> -->
        <td>
          <ul>
            <li *ngFor="let planification of rowData['planifications']">
              {{ planification.startedAt }} - {{ planification.endedAt }}
            </li>
          </ul>
        </td>
        <td>
          <ul>
            <li *ngFor="let planification of rowData['planifications']">
              {{ planification.responsibleCourse.user.fullname }}
            </li>
          </ul>
        </td>
        <td>
          <ul>
            <li *ngFor="let planification of rowData['planifications']">
              {{ planification.state.name }}

              <!-- <div class="field xl:col-6 lg:col-6 md:col-12 sm:col-12"> -->
              <label
                for="statePlanification"
                appLabel
                label="Tipo de estados de la planificación:"
              >
              </label>
              <p-dropdown
                #estadoPlanificacion
                (onChange)="SaveStatePlanification(rowData, $event.value)"
                id="statePlanification"
                dataKey="id"
                [options]="planificationStates"
                [filter]="true"
                filterBy="name"
                placeholder="Seleccione"
              >
                <ng-template pTemplate="selectedItem">
                  <div>
                    <div>{{ estadoPlanificacion.value?.name }}</div>
                  </div>
                </ng-template>
                <ng-template let-item pTemplate="item">
                  <div>
                    <div>{{ item.name }}</div>
                  </div>
                </ng-template>
              </p-dropdown>
              <!-- </div> -->
            </li>
          </ul>
        </td>
        <td>
          <ul>
            <li *ngFor="let planification of rowData['planifications']">
              {{ planification.observations }}
            </li>
          </ul>
        </td>
        <td class="text-center">
          <p-splitButton
            label="Mas"
            styleClass="p-button-secondary"
            icon="pi pi-user-edit"
            (onDropdownClick)="select(rowData)"
            [model]="items"
          ></p-splitButton>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="summary">
      {{ messageService.paginatorTotalRegisters(paginator) }}
    </ng-template>
    <ng-template pTemplate="emptymessage" let-columns>
      <tr>
        <td [attr.colspan]="columns.length">
          {{ messageService.paginatorNoRecordsFound }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

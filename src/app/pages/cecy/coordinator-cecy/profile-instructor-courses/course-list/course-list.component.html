<p-dialog
  header="Agregar Perfil"
  [(visible)]="dialogForm"
  [maximizable]="true"
  [modal]="true"
>
  <app-course-profile-form
    *ngIf="dialogForm"
    (dialogForm)="dialogForm = $event"
    [id]="selectedCourse.id"
  ></app-course-profile-form>
</p-dialog>

<p-dialog
  header="Asignación de instructores"
  [(visible)]="dialogList"
  [maximizable]="true"
  [modal]="true"
>
  <app-assignment-instructors-form
    *ngIf="dialogList"
    (dialogList)="dialogList = $event"
  >
  </app-assignment-instructors-form>
</p-dialog>

<p-dialog
  header="Perfil del Curso"
  [(visible)]="dialogPerfilForm"
  [maximizable]="true"
  [modal]="true"
>
  <!-- <app-show-perfil-form
    *ngIf="dialogPerfilForm"
    (dialogForm)="dialogForm = $event"
    [id]="selectedCourse.profilecourse.id"
  ></app-show-perfil-form> -->
</p-dialog>

<div class="container">
  <p-toolbar>
    <div class="p-toolbar-group-right">
      <h1>Visualización de Cursos</h1>

      <button
        pButton
        pRipple
        type="button"
        label="Refrescar"
        class="p-button-rounded ml-2"
        icon="pi pi-sync"
        (click)="loadCourses(paginator.current_page)"
      ></button>
      <button
        *ngIf="selectedCourses?.length"
        pButton
        pRipple
        type="button"
        label="Eliminar seleccionados"
        class="p-button-danger p-button-rounded ml-2"
        icon="pi pi-trash"
        (click)="deleteCourses()"
      ></button>
      <app-progress-bar
        *ngIf="progressBarDelete"
        [message]="messageService.progressBarDelete"
        class="ml-2"
      >
      </app-progress-bar>
    </div>

    <div class="p-toolbar-group-right">
      <div class="p-inputgroup">
        <input
          pInputText
          id="search"
          [formControl]="search"
          (keypress)="filter($event)"
        />
        <button
          pButton
          pRipple
          type="button"
          icon="pi pi-search"
          (click)="filter($event)"
        ></button>
      </div>
    </div>
  </p-toolbar>

  <p-card>
    <p-paginator
      [rows]="paginator.per_page!"
      [totalRecords]="paginator.total!"
      (onPageChange)="paginate($event)"
    >
    </p-paginator>
    <p-table
      dataKey="id"
      styleClass="p-datatable-striped"
      [value]="(courses$ | async)?.data"
      [columns]="cols"
      [loading]="(loaded$ | async)!"
      [(selection)]="selectedCourses"
      [responsive]="true"
    >
      <ng-template pTemplate="header" let-columns>
        <tr>
          <th style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>

          <th pSortableColumn="code">
            Código de Curso
            <p-sortIcon field="code"></p-sortIcon>
          </th>
          <th pSortableColumn="name">
            Nombre de Curso
            <p-sortIcon field="name"></p-sortIcon>
          </th>
          <th pSortableColumn="state.name">
            Estado
            <p-sortIcon field="state.name"></p-sortIcon>
          </th>
          <!--<th pSortableColumn="career.name">Carrera
                                <p-sortIcon field="career.name"></p-sortIcon>
                            </th>-->
          <th pSortableColumn="duration.name">
            Duración en horas
            <p-sortIcon field="duration.name"></p-sortIcon>
          </th>
          <th pSortableColumn="instructor">
            Instructor Capacitado
            <p-sortIcon field="instructor"></p-sortIcon>
          </th>

          <th class="text-center">
            <button
              pButton
              pRipple
              type="button"
              class="p-button-rounded p-button-secondary"
              icon="pi pi-cog"
            ></button>
          </th>
        </tr>
      </ng-template>
      <ng-template
        pTemplate="body"
        let-rowData
        let-columns="columns"
        let-rowIndex="rowIndex"
      >
        <tr [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex">
          <td>
            <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
          </td>
          <td *ngFor="let col of columns">
            <!--Objects-->
            <div *ngIf="rowData[col.field]?.id" [ngSwitch]="col.field">
              <div *ngSwitchCase="'state'">
                {{ rowData[col.field].name }}
              </div>
              <div *ngSwitchCase="'career'">
                {{ rowData[col.field].name }}
              </div>
            </div>

            <!--Fields-->
            <div *ngIf="!rowData[col.field]?.id" [ngSwitch]="col.field">
              <div *ngSwitchCase="'instructor'">
                <div *ngFor="let instructor of rowData[col.field]">
                  {{ instructor.user.name }}
                </div>
              </div>

              <div *ngSwitchDefault>{{ rowData[col.field] }}</div>
            </div>
          </td>
          <td class="text-center">
            <p-splitButton
              label="Más"
              styleClass="p-button-secondary"
              icon="pi pi-user-edit"
              (onDropdownClick)="selectCourse(rowData)"
              [model]="items"
            >
            </p-splitButton>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="summary">
        {{ messageService.paginatorTotalRegisters(paginator) }}
      </ng-template>
      <ng-template pTemplate="emptymessage" let-columns>
        <tr>
          <td [attr.colspan]="columns.length">
            {{ messageService.paginatorNoRecordsFound }}
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>
